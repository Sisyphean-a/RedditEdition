# VS Code Stealth Reader (Reddit Edition) 实现文档

## 1. 项目概述

VS Code 扩展，伪装成日志查看器来阅读 Reddit 内容。所有内容经 Gemini 翻译为中文后显示。

### 核心原则

- **隐蔽性**：UI 伪装成文件树和日志文件，禁用 Webview
- **纯中文**：所有内容翻译后显示，翻译失败显示伪装错误码
- **防风控**：请求间隔 2 秒，按帖子缓存

## 2. 技术栈

- VS Code Extension API (Node.js)
- TypeScript
- Axios（HTTP 请求）
- Google Gemini 2.0 Flash（翻译）
- globalStorage（缓存）

## 3. 项目结构

```
src/
├── extension.ts          # 入口，注册命令和 Provider
├── config.ts             # 配置读取
├── rateLimiter.ts        # 请求限流器
├── cache.ts              # 缓存管理
├── redditClient.ts       # Reddit API 客户端
├── translator.ts         # Gemini 翻译服务
├── treeProvider.ts       # 侧边栏 TreeView
└── contentProvider.ts    # 虚拟文档内容
```

## 4. 配置项

在 `package.json` 的 `contributes.configuration` 中注册：

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `logViewer.redditCookie` | string | `""` | Reddit Cookie |
| `logViewer.subreddits` | array | `["programming"]` | 订阅板块列表 |
| `logViewer.geminiApiKey` | string | `""` | Gemini API Key |
| `logViewer.cacheDuration` | number | `30` | 缓存时长（分钟） |

## 5. 模块设计

### 5.1 config.ts

```typescript
export interface Config {
  redditCookie: string;
  subreddits: string[];
  geminiApiKey: string;
  cacheDuration: number; // 分钟
}

export function getConfig(): Config;
```

### 5.2 rateLimiter.ts

令牌桶限流器，确保请求间隔至少 2000ms。

```typescript
export class RateLimiter {
  private lastRequest: number = 0;
  private queue: Array<() => void> = [];
  private processing: boolean = false;

  async acquire(): Promise<void>;
}
```

### 5.3 cache.ts

基于 globalStorage 的缓存，按帖子 ID 存储。

```typescript
interface CacheEntry<T> {
  data: T;
  timestamp: number;
}

export class CacheManager {
  constructor(storage: vscode.Memento);

  get<T>(key: string): T | null;
  set<T>(key: string, data: T): void;
  clear(): void;
}
```

缓存 Key 格式：
- 帖子列表：`list:{subreddit}:{offset}`
- 帖子详情：`post:{postId}`
- 翻译结果：`trans:{postId}`

### 5.4 redditClient.ts

```typescript
interface RedditPost {
  id: string;
  title: string;
  selftext: string;
  author: string;
  score: number;
  created_utc: number;
  num_comments: number;
}

interface RedditComment {
  id: string;
  author: string;
  body: string;
  score: number;
  replies: RedditComment[];
}

export class RedditClient {
  constructor(limiter: RateLimiter, cookie: string);

  // 获取帖子列表，每次 25 条
  async fetchSubreddit(subreddit: string, after?: string): Promise<{
    posts: RedditPost[];
    after: string | null;
  }>;

  // 获取帖子详情和评论
  async fetchPost(subreddit: string, postId: string): Promise<{
    post: RedditPost;
    comments: RedditComment[];
  }>;
}
```

API 端点：
- 列表：`https://www.reddit.com/r/{subreddit}/hot.json?limit=25&after={after}`
- 详情：`https://www.reddit.com/r/{subreddit}/comments/{postId}.json`

请求头：
```typescript
{
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
  'Cookie': cookie
}
```

### 5.5 translator.ts

使用 Gemini 2.0 Flash 批量翻译。

```typescript
interface TranslatedPost {
  title: string;
  selftext: string;
  comments: TranslatedComment[];
}

interface TranslatedComment {
  author: string;
  body: string;
  replies: TranslatedComment[];
}

export class Translator {
  constructor(apiKey: string);

  // 翻译整个帖子（标题+正文+评论）
  async translatePost(post: RedditPost, comments: RedditComment[]): Promise<TranslatedPost>;
}
```

Prompt 模板：
```
将以下 Reddit 帖子翻译成中文，保持口语化风格。
只返回 JSON，格式如下：
{
  "title": "翻译后的标题",
  "selftext": "翻译后的正文",
  "comments": [
    {
      "author": "保留原作者名",
      "body": "翻译后的评论",
      "replies": [...]
    }
  ]
}

原文：
{json}
```

评论处理：
- 初始翻译前 10 条顶级评论
- 嵌套最多 3 层
- "加载更多"时追加翻译 10 条

### 5.6 treeProvider.ts

侧边栏 TreeView，伪装成文件浏览器。

```typescript
export class RedditTreeProvider implements vscode.TreeDataProvider<TreeNode> {
  // 数据结构
  private subreddits: Map<string, {
    posts: PostNode[];
    after: string | null;
  }>;

  // 刷新事件
  private _onDidChangeTreeData: vscode.EventEmitter<TreeNode | undefined>;

  getTreeItem(element: TreeNode): vscode.TreeItem;
  getChildren(element?: TreeNode): TreeNode[];

  // 操作方法
  refresh(subreddit?: string): Promise<void>;
  loadMorePosts(subreddit: string): Promise<void>;
}
```

节点类型：
```typescript
type TreeNode = SubredditNode | PostNode | LoadMoreNode;

interface SubredditNode {
  type: 'subreddit';
  name: string;
  iconPath: ThemeIcon; // Folder
}

interface PostNode {
  type: 'post';
  id: string;
  subreddit: string;
  title: string;        // 翻译后的中文标题
  iconPath: ThemeIcon;  // File
}

interface LoadMoreNode {
  type: 'loadMore';
  subreddit: string;
  iconPath: ThemeIcon;  // Ellipsis
}
```

### 5.7 contentProvider.ts

虚拟文档，伪装成 `.log` 文件。

```typescript
export class LogContentProvider implements vscode.TextDocumentContentProvider {
  // URI 格式: stealth-log:/r/{subreddit}/{postId}.log

  provideTextDocumentContent(uri: vscode.Uri): Promise<string>;

  // 加载更多评论后刷新
  update(uri: vscode.Uri): void;
}
```

输出格式：
```
================================================================================
[SYSTEM LOG] 2026-01-27 14:30:00 | PID: {postId}
================================================================================

[INFO] 作者: {author} | 评分: {score} | 评论数: {num_comments}
[TITLE] {翻译后的标题}

[CONTENT]
{翻译后的正文，如果为空显示 "[无正文内容]"}

================================================================================
[TRACE LOG] 评论区
================================================================================

[#001] {author} (+{score})
       {翻译后的评论内容}
       │
       ├─ [#001.1] {author} (+{score})
       │          {嵌套评论内容}
       │          │
       │          └─ [#001.1.1] {author} (+{score})
       │                       {第三层评论}
       │
       └─ [#001.2] {author} (+{score})
                  {另一条嵌套评论}

[#002] {author} (+{score})
       {评论内容}

...

--------------------------------------------------------------------------------
[DEBUG] 已加载 10/128 条评论 | 输入 :more 加载更多
--------------------------------------------------------------------------------
```

翻译失败时的显示：
```
[ERROR] 0x0001 数据解码失败 | 时间戳: {timestamp}
[TRACE] 模块: ContentDecoder | 状态: FAILED
```

## 6. 命令注册

| 命令 ID | 标题 | 说明 |
|---------|------|------|
| `logViewer.refresh` | 刷新日志 | 刷新当前/指定板块 |
| `logViewer.refreshAll` | 刷新所有日志 | 刷新所有板块 |
| `logViewer.clearCache` | 清除缓存 | 清空所有缓存数据 |
| `logViewer.loadMorePosts` | 加载更多 | 加载更多帖子 |
| `logViewer.loadMoreComments` | 加载更多评论 | 加载更多评论 |

## 7. extension.ts 入口

```typescript
export function activate(context: vscode.ExtensionContext) {
  const config = getConfig();

  // 初始化模块
  const limiter = new RateLimiter();
  const cache = new CacheManager(context.globalState);
  const client = new RedditClient(limiter, config.redditCookie);
  const translator = new Translator(config.geminiApiKey);

  // 注册 Provider
  const treeProvider = new RedditTreeProvider(client, translator, cache, config);
  const contentProvider = new LogContentProvider(client, translator, cache);

  // 注册 TreeView
  vscode.window.registerTreeDataProvider('logViewer', treeProvider);

  // 注册虚拟文档 scheme
  vscode.workspace.registerTextDocumentContentProvider('stealth-log', contentProvider);

  // 注册命令
  context.subscriptions.push(
    vscode.commands.registerCommand('logViewer.refresh', (node) => treeProvider.refresh(node?.name)),
    vscode.commands.registerCommand('logViewer.refreshAll', () => treeProvider.refresh()),
    vscode.commands.registerCommand('logViewer.clearCache', () => cache.clear()),
    vscode.commands.registerCommand('logViewer.loadMorePosts', (node) => treeProvider.loadMorePosts(node.subreddit)),
    vscode.commands.registerCommand('logViewer.loadMoreComments', (uri) => contentProvider.loadMoreComments(uri))
  );
}
```

## 8. package.json 关键配置

```json
{
  "name": "log-viewer",
  "displayName": "Log Viewer",
  "description": "A simple log file viewer",
  "contributes": {
    "configuration": {
      "title": "Log Viewer",
      "properties": {
        "logViewer.redditCookie": {
          "type": "string",
          "default": "",
          "description": "数据源认证信息"
        },
        "logViewer.subreddits": {
          "type": "array",
          "default": ["programming"],
          "description": "数据源列表"
        },
        "logViewer.geminiApiKey": {
          "type": "string",
          "default": "",
          "description": "解码服务密钥"
        },
        "logViewer.cacheDuration": {
          "type": "number",
          "default": 30,
          "description": "缓存时长（分钟）"
        }
      }
    },
    "views": {
      "explorer": [
        {
          "id": "logViewer",
          "name": "日志文件"
        }
      ]
    },
    "commands": [
      { "command": "logViewer.refresh", "title": "刷新日志" },
      { "command": "logViewer.refreshAll", "title": "刷新所有日志" },
      { "command": "logViewer.clearCache", "title": "清除缓存" },
      { "command": "logViewer.loadMorePosts", "title": "加载更多" },
      { "command": "logViewer.loadMoreComments", "title": "加载更多评论" }
    ],
    "menus": {
      "view/item/context": [
        {
          "command": "logViewer.refresh",
          "when": "viewItem == subreddit"
        },
        {
          "command": "logViewer.loadMorePosts",
          "when": "viewItem == loadMore"
        }
      ]
    }
  }
}
```

## 9. 数据流

```
用户点击帖子
    ↓
检查缓存 (cache.get)
    ↓ (未命中)
限流等待 (limiter.acquire)
    ↓
请求 Reddit API (client.fetchPost)
    ↓
翻译内容 (translator.translatePost)
    ↓
写入缓存 (cache.set)
    ↓
渲染为日志格式 (contentProvider)
    ↓
打开虚拟文档 (vscode.open)
```

## 10. 默认值汇总

| 项目 | 默认值 |
|------|--------|
| 请求间隔 | 2000ms |
| 缓存时长 | 30 分钟 |
| 帖子每页数量 | 25 条 |
| 初始评论数量 | 10 条 |
| 加载更多评论 | 10 条 |
| 评论嵌套层级 | 3 层 |
| 翻译模型 | gemini-2.0-flash |
| 虚拟文档后缀 | .log |
| 命令前缀 | logViewer |
| 侧边栏标题 | 日志文件 |

## 11. 依赖

```json
{
  "dependencies": {
    "axios": "^1.6.0",
    "@google/generative-ai": "^0.2.0"
  }
}
```
